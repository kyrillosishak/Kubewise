suite: Service Tests
templates:
  - api-service.yaml
tests:
  - it: should create Service when API enabled
    set:
      recommendationApi.enabled: true
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-container-resource-predictor-api

  - it: should not create Service when API disabled
    set:
      recommendationApi.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should expose REST port
    set:
      recommendationApi.enabled: true
      recommendationApi.service.restPort: 8080
    asserts:
      - contains:
          path: spec.ports
          content:
            name: rest
            port: 8080
            targetPort: rest
            protocol: TCP

  - it: should expose gRPC port
    set:
      recommendationApi.enabled: true
      recommendationApi.service.grpcPort: 9000
    asserts:
      - contains:
          path: spec.ports
          content:
            name: grpc
            port: 9000
            targetPort: grpc
            protocol: TCP

  - it: should expose metrics port when enabled
    set:
      recommendationApi.enabled: true
      recommendationApi.metrics.enabled: true
      recommendationApi.metrics.port: 9091
    asserts:
      - contains:
          path: spec.ports
          content:
            name: metrics
            port: 9091
            targetPort: metrics
            protocol: TCP

  - it: should use ClusterIP by default
    set:
      recommendationApi.enabled: true
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should allow custom service type
    set:
      recommendationApi.enabled: true
      recommendationApi.service.type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should add service annotations
    set:
      recommendationApi.enabled: true
      recommendationApi.service.annotations:
        service.beta.kubernetes.io/aws-load-balancer-internal: "true"
    asserts:
      - equal:
          path: metadata.annotations["service.beta.kubernetes.io/aws-load-balancer-internal"]
          value: "true"
